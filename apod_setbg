#!/bin/bash

font=/home/gammy/code/perl/apod_get/font/Istok-Regular.ttf # XXX the plague!

trap boom ERR

set_background() {

	echo "Setting \"$1\" as background."

	# Appropriate for gnome
	# Note that gconftool of course needs a full path (not relative)
	gconftool-2 -t str -s /desktop/gnome/background/picture_options "zoom"
	gconftool-2 -t str -s /desktop/gnome/background/picture_filename "$1"

	# Other methods of setting the background
	#hsetroot -center "$1"
	# feh --bg-center "$1"
	#         fbsetbg "$1"

	return;
}

boom() {
	echo "Fatal error."
	exit 1
}

usage() {
	     echo "Usage: $(basename $0) [-t <text-file>] [-s <WxH>] -i <input image> -o <output image>"
	     echo "-t foo.txt        Annotate image with content of 'foo.txt'"
	     echo "-i in.png         Input file : Use 'in.png' as background"
	     echo "-o out.png        Output file: Output result to 'out.png'"
	     echo "-s 1024x600       Set result image size to 1024x600"
	     echo
}

opt_text=
file_src=
file_dst=
opt_size="--desktop-size"

while getopts “ht:i:o:s:” opt; do
	case $opt in
		i)
			file_src=$OPTARG
			;;
		o)
			file_dst=$OPTARG
			;;
		t)
			opt_text="--text-file=${OPTARG}"
			;;
		s)
			opt_size="--size=$OPTARG"
			;;
		h)
			usage
			exit
			;;
	esac
done

if [[ -z ${file_src} ]] || [[ -z ${file_dst} ]]; then
	usage
	exit
fi

if [ ! -f ${font} ]; then
	echo Unable to find \"${font}\": Please edit $0 to specify a working \
	font path.
	exit
fi

linnea_annotate ${opt_size} \
		${opt_text} \
		--font-file="${font}" \
		--font-pts=12 \
		--valign=bottom \
                "${file_src}" \
		"${file_dst}"

set_background "${file_dst}"
